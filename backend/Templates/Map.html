{% extends "base.html" %}
{% block title %}Peak Times{% endblock %}

{% block content %}
{% if messages %}
<div class="messages" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
    {% for message in messages %}
    <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %}" 
        style="padding: 15px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<style>
  /* Move all styles to the top of the file */
  #location-access-prompt {
    display: none; /* Initially hidden */
    width: 300px;
    margin: 0 auto;
    text-align: center;
    padding: 20px;
    border: 2px solid #ccc;
    border-radius: 10px;
    background-color: #f9f9f9;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  #location-access-prompt h3 {
    margin-bottom: 15px;
    color: #333;
  }

  #location-access-prompt button {
    margin: 5px;
    padding: 8px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.2s;
  }

  #grant-location-btn {
    background-color: #4CAF50;
    color: white;
  }

  #grant-location-btn:hover {
    background-color: #45a049;
  }

  #deny-location-btn {
    background-color: #f44336;
    color: white;
  }

  #deny-location-btn:hover {
    background-color: #da190b;
  }

  /* Login Section Styling */
  #login-section {
    width: 90%;
    max-width: 400px;
    margin: 2rem auto;
    padding: 2rem;
    background-color: var(--card-background);
    border-radius: 1rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
  }

  #login-section form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  #login-section label {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }

  #login-section input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  #login-section input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  #login-section button {
    width: 100%;
    padding: 0.75rem 1.5rem;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  #login-section button:hover {
    background-color: var(--primary-hover);
    transform: translateY(-1px);
  }

  /* Loading States */
  .loading {
    position: relative;
    pointer-events: none;
    opacity: 0.7;
  }

  .loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 24px;
    height: 24px;
    margin: -12px 0 0 -12px;
    border: 2px solid var(--primary-color);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Error Messages */
  .error-message {
    display: none !important;
  }

  /* Success Messages */
  .success-message {
    display: none !important;
  }

  /* Map Controls */
  .map-controls {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 1000;
    background: white;
    padding: 0.5rem;
    border-radius: 0.5rem;
    box-shadow: var(--shadow-md);
  }

  .map-controls button {
    display: block;
    width: 100%;
    margin: 0.25rem 0;
    padding: 0.5rem;
    border: none;
    border-radius: 0.25rem;
    background: var(--primary-color);
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .map-controls button:hover {
    background: var(--primary-hover);
  }

  /* Place Info Box Styling */
  #place-info-box {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 90%;
    max-width: 400px;
    background: white;
    border-radius: 1rem;
    box-shadow: var(--shadow-lg);
    padding: 1.5rem;
    z-index: 1000;
    transform: translateY(0);
    transition: transform 0.3s ease;
    display: none;
  }

  #place-info-box.visible {
    display: block;
    animation: slideUp 0.3s ease forwards;
  }

  #place-info-box.hidden {
    animation: slideDown 0.3s ease forwards;
  }

  @keyframes slideUp {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes slideDown {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(100%);
      opacity: 0;
    }
  }

  #place-info-box h4 {
    color: var(--text-primary);
    font-size: 1.25rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-color);
  }

  #place-info-box p {
    margin: 0.5rem 0;
    color: var(--text-secondary);
  }

  #place-info-box strong {
    color: var(--text-primary);
  }

  .close-info {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1.25rem;
    line-height: 1;
    transition: color 0.3s ease;
  }

  .close-info:hover {
    color: var(--text-primary);
  }

  /* Hide system messages */
  .error-message,
  .success-message {
    display: none !important;
  }

  /* General input and button styling */
  input, button {
    margin-top: 10px;
    padding: 10px 15px;
    border-radius: 5px;
    border: 1px solid #ccc;
    width: 80%;
    box-sizing: border-box;
  }

  button {
    cursor: pointer;
    background-color: #4CAF50;
    color: white;
    font-weight: bold;
  }

  button:hover {
    background-color: #45a049;
  }

  /* Map box styling */
  .map-box {
    height: 600px;
    width: 90%;
    margin: 20px auto;
    border: 2px solid #ccc;
    border-radius: 12px;
  }

  /* Info box styling */
  .info-box {
    border: 1px solid #ccc;
    padding: 15px;
    margin-top: 20px;
    border-radius: 10px;
    max-width: 90%;
    margin-left: auto;
    margin-right: auto;
    background-color: #f9f9f9;
  }

  /* Form layout for manual location section */
  #manual-location-section {
    text-align: center;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 10px;
  }

  /* Chart section */
  #chart-wrapper {
    display: none; /* change this from 'block' to 'none' */
    text-align: center;
  }
  

  #place-info-box {
    display: none;
    text-align: center;
  }

  @keyframes highlight {
    0% { box-shadow: 0 0 0px rgba(255, 0, 0, 0.7); }
    50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.7); }
    100% { box-shadow: 0 0 0px rgba(255, 0, 0, 0.7); }
  }
  
  .chart-highlight {
    animation: highlight 1.5s ease-in-out;
  }
  
  /* Related Places Styling */
  #related-places {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
  }

  #related-places h5 {
    color: var(--text-primary);
    font-size: 1.1rem;
    margin-bottom: 1rem;
  }

  .related-place-card {
    background: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }

  .related-place-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .related-place-card h6 {
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-size: 1rem;
  }

  .related-place-card p {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
  }

  .related-place-card .badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.65rem;
  }

  .spinner-border {
    width: 1.5rem;
    height: 1.5rem;
    margin: 1rem auto;
  }

  .alert {
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
  }

  .alert-info {
    background-color: #e3f2fd;
    border-color: #bbdefb;
    color: #0d47a1;
  }

  .alert-danger {
    background-color: #ffebee;
    border-color: #ffcdd2;
    color: #b71c1c;
  }
</style>

<div id="main-map-container">
  {% if not user.is_authenticated %}
    <div id="login-section">
      <form method="POST" action="{% url 'login' %}">
        {% csrf_token %}
        <label for="email">Email:</label><br>
        <input type="email" name="email" required><br>
        <label for="password">Password:</label><br>
        <input type="password" name="password" required><br>
        <button type="submit">Login</button>
      </form>
    </div>
    <div id="city-search-bar" style="display:none; position: absolute; top: 64px; right: 0; z-index: 1200; align-items: center; min-width: 160px; max-width: 220px; background: #fff; border-radius: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.13); padding: 0.1rem 0.7rem;">
      <span style="color: #65676b; font-size: 1rem; margin-right: 0.4rem; display: flex; align-items: center;">
        <i class="fa fa-search"></i>
      </span>
      <input id="location-input" type="text" placeholder="Search..." style="flex:1; border:none; outline:none; background: transparent; font-size: 0.95rem; color: #22223b; padding: 0.4rem 0; min-width: 50px;" />
      <button id="search-button" type="button" style="background: #2563eb; color: #fff; border: none; border-radius: 2rem; padding: 0.4rem 1rem; font-weight: 500; font-size: 0.95rem; margin-left: 0.4rem; cursor: pointer; transition: background 0.2s;">Search</button>
    </div>
    <div id="location-access-prompt">
      <h3>Allow location access?</h3>
      <button id="grant-location-btn">Yes</button>
      <button id="deny-location-btn">No</button>
    </div>

    <div id="manual-location-section" style="display:none;">
      <h3>Enter Your Location Manually:</h3>
      <input type="text" id="manual-location-input" placeholder="e.g., Kathmandu, Nepal" />
      <button id="submit-manual-location">Submit</button>
    </div>

    <div id="map-wrapper" style="display:none;">
      <div id="map" class="map-box"></div>
    </div>
    <div id="distances">
    <!-- Distances will be dynamically added here by JavaScript -->
    </div>
    
    <div id="chart-wrapper" style="display:none;">
      <h3>Popular Places in Selected District</h3>
      <canvas id="bar-chart" width="600" height="300"></canvas>
    </div>

    <div id="place-info-box" style="display:none;" class="info-box">
      <h4 id="place-title"></h4>
      <p id="place-description"></p>
      <p><strong>Popular For:</strong> <span id="place-popular"></span></p>
      <p><strong>Category:</strong> <span id="place-category"></span></p>
      <p><strong>Crowd Level:</strong> <span id="place-crowd"></span></p>
      <p><strong>Status:</strong> <span id="place-status"></span></p>
      <p><strong>Tags:</strong> <span id="place-tags"></span></p>
      <div id="related-places" class="mt-4">
        <h5>Related Places</h5>
        <div id="related-places-list"></div>
      </div>
    </div>
  {% else %}
    <div id="location-access-prompt">
      <h3>Allow location access?</h3>
      <button id="grant-location-btn">Yes</button>
      <button id="deny-location-btn">No</button>
    </div>

    <div id="manual-location-section" style="display:none;">
      <h3>Enter Your Location Manually:</h3>
      <input type="text" id="manual-location-input" placeholder="e.g., Kathmandu, Nepal" />
      <button id="submit-manual-location">Submit</button>
    </div>

    <div id="map-wrapper" style="display:none;">
      <div id="map" class="map-box"></div>
    </div>
    <div id="distances">
    <!-- Distances will be dynamically added here by JavaScript -->
    </div>
    
    <div id="chart-wrapper" style="display:none;">
      <h3>Popular Places in Selected District</h3>
      <canvas id="bar-chart" width="600" height="300"></canvas>
    </div>

    <div id="place-info-box" style="display:none;" class="info-box">
      <h4 id="place-title"></h4>
      <p id="place-description"></p>
      <p><strong>Popular For:</strong> <span id="place-popular"></span></p>
      <p><strong>Category:</strong> <span id="place-category"></span></p>
      <p><strong>Crowd Level:</strong> <span id="place-crowd"></span></p>
      <p><strong>Status:</strong> <span id="place-status"></span></p>
      <p><strong>Tags:</strong> <span id="place-tags"></span></p>
      <div id="related-places" class="mt-4">
        <h5>Related Places</h5>
        <div id="related-places-list"></div>
      </div>
    </div>
  {% endif %}
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let map, userLatLng = null, userMarker, routePolyline = null;

  const redIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  // Utility functions
  function showLoading(element) {
    element.classList.add('loading');
  }

  function hideLoading(element) {
    element.classList.remove('loading');
  }

  function showError(message) {
    console.error(message);
  }

  function showSuccess(message) {
    console.log(message);
  }

  // Wait for DOM and styles to be fully loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Show the location prompt after a small delay to ensure styles are applied
    setTimeout(() => {
      document.getElementById("location-access-prompt").style.display = "block";
    }, 100);

    document.getElementById("grant-location-btn").addEventListener("click", () => {
      document.getElementById("location-access-prompt").style.display = "none";
      initializeMap();
      getCurrentLocation();
      localStorage.removeItem('location_denied');
      window.dispatchEvent(new Event('userLocationSet'));
      if (typeof showNavbarSearchBarIfAllowed === 'function') {
        showNavbarSearchBarIfAllowed();
      }
    });

    document.getElementById("deny-location-btn").addEventListener("click", () => {
      document.getElementById("location-access-prompt").style.display = "none";
      document.getElementById("manual-location-section").style.display = "block";
      initializeMap();
      localStorage.setItem('location_denied', 'true');
      window.dispatchEvent(new Event('userLocationSet'));
    });

    document.getElementById("submit-manual-location").addEventListener("click", async () => {
      const locationInput = document.getElementById("manual-location-input").value.trim();

      if (!locationInput) {
        alert("Please enter a location.");
        return;
      }

      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationInput)}`);
        const data = await response.json();

        if (data.length === 0) {
          alert("Location not found. Reloading page...");
          window.location.reload();
          return;
        }

        const result = data[0];
        const displayName = result.display_name.toLowerCase();

        if (!displayName.includes("nepal")) {
          alert("Only locations within Nepal are supported. Reloading page...");
          window.location.reload();
          return;
        }

        const lat = parseFloat(result.lat);
        const lon = parseFloat(result.lon);
        userLatLng = [lat, lon];
        localStorage.setItem('user_lat', lat);
        localStorage.setItem('user_lng', lon);

        alert(`Location set to: ${result.display_name}`);
        showUserLocation(userLatLng, "Manual Location Set");
        document.getElementById("manual-location-section").style.display = "none";
        document.getElementById("city-search-bar").style.display = "flex";
        window.dispatchEvent(new Event('userLocationSet'));

      } catch (error) {
        console.error("Error validating location:", error);
        alert("Something went wrong. Reloading page...");
        window.location.reload();
      }
    });

    document.getElementById("search-button").addEventListener("click", async () => {
      const searchButton = document.getElementById("search-button");
      const input = document.getElementById("location-input").value.trim();
      if (!input || !userLatLng) {
        showError("Please set your location and enter a district name, place name, or #category.");
        return;
      }
      showLoading(searchButton);
      try {
        if (input.startsWith("#")) {
          const category = input.slice(1);
          await fetchPlacesByCategory(category);
        } else {
          // Try district first
          let districtResponse = await fetch(`/places-by-district/${input}/`);
          let districtData = await districtResponse.json();
          if (districtData.places && districtData.places.length > 0) {
            await fetchPlacesByDistrict(input);
          } else {
            // If not found as district, try as place name
            await fetchPlaceByName(input);
          }
        }
        showSuccess('Search completed successfully');
      } catch (error) {
        console.error('Search error:', error);
        showError('Failed to complete search. Please try again.');
      } finally {
        hideLoading(searchButton);
      }
    });

    // Add keyboard support for search
    document.getElementById("location-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        document.getElementById("search-button").click();
      }
    });
  });

  // Initialize map with better error handling
  function initializeMap() {
    try {
      document.getElementById("map-wrapper").style.display = "block";
      map = L.map('map').setView([27.7, 85.3], 13);
      
      // Add different map layers
      const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      });

      const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri'
      });

      const baseMaps = {
        "Street": osmLayer,
        "Satellite": satelliteLayer
      };

      L.control.layers(baseMaps).addTo(map);
      osmLayer.addTo(map);

      // Add zoom control
      L.control.zoom({
        position: 'bottomright'
      }).addTo(map);

      // Add scale control
      L.control.scale({
        imperial: false,
        position: 'bottomleft'
      }).addTo(map);

      showSuccess('Map initialized successfully');
    } catch (error) {
      console.error('Error initializing map:', error);
      showError('Failed to initialize map. Please refresh the page.');
    }
  }

  // Improved location handling
  function getCurrentLocation() {
    const locationPrompt = document.getElementById("location-access-prompt");
    showLoading(locationPrompt);

    navigator.geolocation.getCurrentPosition(
      pos => {
        hideLoading(locationPrompt);
        userLatLng = [pos.coords.latitude, pos.coords.longitude];
        localStorage.setItem('user_lat', pos.coords.latitude);
        localStorage.setItem('user_lng', pos.coords.longitude);
        showUserLocation(userLatLng, "You are here!");
        document.getElementById("city-search-bar").style.display = "flex";
        window.dispatchEvent(new Event('userLocationSet'));
      },
      error => {
        hideLoading(locationPrompt);
        console.error('Geolocation error:', error);
        document.getElementById("manual-location-section").style.display = "block";
      },
      {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      }
    );
  }

  function showUserLocation(coords, label) {
    userLatLng = coords;
    map.setView(coords, 13);

    if (userMarker) map.removeLayer(userMarker);

    userMarker = L.marker(coords, { icon: redIcon, draggable: true })
      .addTo(map)
      .bindPopup(label)
      .openPopup();

    userMarker.on('dragend', function (e) {
      const newCoords = e.target.getLatLng();
      userLatLng = [newCoords.lat, newCoords.lng];

      // Remove any existing blue route
      if (routePolyline) {
        map.removeLayer(routePolyline);
        routePolyline = null;
      }

      userMarker.bindPopup("Loading location name...").openPopup();

      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${newCoords.lat}&lon=${newCoords.lng}&format=json`)
        .then(res => res.json())
        .then(data => {
          let shortName = "Unknown location";
          if (data.address) {
            const addr = data.address;
            // Compose a short label: prefer road + city/town/village + state_district
            shortName = [
              addr.road,
              addr.suburb,
              addr.city || addr.town || addr.village,
              addr.state_district || addr.state
            ].filter(Boolean).join(', ');
            if (!shortName) shortName = addr.country || data.display_name || "Unknown location";
          } else if (data.display_name) {
            shortName = data.display_name;
          }
          userMarker.setPopupContent(shortName).openPopup();
        })
        .catch(err => {
          console.error("Reverse geocoding failed:", err);
          userMarker.setPopupContent("Location name not found").openPopup();
        });
    });
  }

  async function geocode(location) {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`);
    const data = await res.json();
    if (data.length > 0) {
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }
    return null;
  }

  function displayPlacesOnMap(places) {
    // Calculate distances and sort places
    const placesWithDistance = places.map(place => ({
      ...place,
      distance: userLatLng ? calculateDistance(
        userLatLng[0], userLatLng[1],
        place.latitude, place.longitude
      ) : Infinity
    }));

    // Sort places by distance
    placesWithDistance.sort((a, b) => a.distance - b.distance);

    // Create numbered markers
    placesWithDistance.forEach((place, index) => {
      if (place.latitude && place.longitude) {
        const number = index + 1;
        const marker = L.marker([place.latitude, place.longitude], {
          icon: L.divIcon({
            className: 'custom-number-icon',
            html: `<div style="background: #4CAF50; color: white; border-radius: 50%; width: 30px; height: 30px; text-align: center; font-weight: bold; line-height: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">${number}</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
          })
        }).addTo(map);

        // Create popup content with distance
        const popupContent = `
          <div style="font-family: Arial, sans-serif; padding: 5px;">
            <strong>${place.name}</strong><br>
            ${place.description || "No description"}<br>
            <small style="color: #666;">Distance: ${place.distance.toFixed(1)} km</small>
          </div>
        `;

        marker.bindPopup(popupContent);

        marker.on('click', () => {
          showPlaceInfo(place);

          // Remove previous routing and number markers
          if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
          }
          // Remove any previous blue lines
          if (window.activeRouteLine) {
            map.removeLayer(window.activeRouteLine);
            window.activeRouteLine = null;
          }
          routeClicks.forEach(m => map.removeLayer(m));
          routeClicks = [];
          routeClickCount = 1;

          if (userLatLng) {
            const userLocation = L.latLng(userLatLng[0], userLatLng[1]);
            const placeLocation = L.latLng(place.latitude, place.longitude);

            routingControl = L.Routing.control({
              waypoints: [userLocation, placeLocation],
              draggableWaypoints: true,
              routeWhileDragging: false,
              createMarker: function(i, wp) {
                if (i === 0) {
                  if (userMarker) map.removeLayer(userMarker);
                  userMarker = L.marker(wp.latLng, {
                    icon: redIcon,
                    draggable: true
                  }).bindPopup("Your Location").addTo(map);

                  userMarker.on('dragend', async function(e) {
                    const newPos = e.target.getLatLng();
                    userLatLng = [newPos.lat, newPos.lng];
                    const locationName = await reverseGeocode(newPos.lat, newPos.lng);
                    userMarker.bindPopup(`<b>Current Location:</b><br>${locationName}`).openPopup();
                  });

                  return userMarker;
                } else {
                  return L.marker(wp.latLng, {
                    icon: L.divIcon({
                      className: 'custom-number-icon',
                      html: `<div style="background: #4CAF50; color: white; border-radius: 50%; width: 30px; height: 30px; text-align: center; font-weight: bold; line-height: 30px;">${number}</div>`,
                      iconSize: [30, 30],
                      iconAnchor: [15, 15]
                    })
                  }).bindPopup(place.name);
                }
              }
            }).addTo(map);

            routingControl.on('routesfound', function(e) {
              // Remove previous blue line if exists
              if (window.activeRouteLine) {
                map.removeLayer(window.activeRouteLine);
              }
              window.activeRouteLine = L.polyline(e.routes[0].coordinates, { color: 'blue' }).addTo(map);
            });
          }
        });
      }
    });

    // Fit map to show all markers
    if (placesWithDistance.length > 0) {
      const bounds = L.latLngBounds(placesWithDistance.map(p => [p.latitude, p.longitude]));
      if (userLatLng) {
        bounds.extend(userLatLng);
      }
      map.fitBounds(bounds, { padding: [50, 50] });
    }
  }
  
  function renderBarChart(places) {
    console.log('Places Data:', places);
  
    // Sort by crowdlevel descending
    places.sort((a, b) => b.crowdlevel - a.crowdlevel);
  
    // Filter places by crowd level with new thresholds
    const highCrowd = places.filter(p => p.crowdlevel > 70).slice(0, 3);
    const mediumCrowd = places.filter(p => p.crowdlevel >= 30 && p.crowdlevel <= 70).slice(0, 2);
    const lowCrowd = places.filter(p => p.crowdlevel < 30).slice(0, 2);
  
    // Combine them
    const selectedPlaces = [...highCrowd, ...mediumCrowd, ...lowCrowd];
  
    const ctx = document.getElementById('bar-chart').getContext('2d');
  
    if (window.barChart) {
      window.barChart.destroy();
    }
  
    const chartData = selectedPlaces.map(place => place.crowdlevel);
    const labels = selectedPlaces.map(place => place.name);
  
    const getColor = (crowdLevel) => {
      if (crowdLevel > 70) return '#FF0000'; // High crowd
      else if (crowdLevel >= 30) return '#FFEB3B'; // Medium crowd
      else return '#4CAF50'; // Low crowd
    };
  
    const backgroundColors = selectedPlaces.map(place => getColor(place.crowdlevel));
  
    window.barChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Crowd Level',
          data: chartData,
          backgroundColor: backgroundColors,
          borderColor: '#388E3C',
          borderWidth: 1
        }]
      },
      options: {
        onClick: function (evt, activeEls, chart) {
          const elements = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
          if (elements.length > 0) {
            const index = elements[0].index;
            const selectedPlace = selectedPlaces[index];
            if (selectedPlace) {
              if (selectedPlace.id) {
                // If we have an ID, redirect to place details
                window.location.href = `/place-details/${selectedPlace.id}/`;
              } else {
                // If no ID, try to search for the place by name
                console.log('No place ID found, searching by name:', selectedPlace.name);
                // You could implement a search by name here or show an alert
                alert(`Place details not available for ${selectedPlace.name}. This place may not be in the database.`);
              }
            }
          }
        },
        responsive: true,
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
  }
  
// Function to fetch places by district
// Function to fetch places by district
async function fetchPlacesByDistrict(district) {
  try {
    console.log("Fetching places for district:", district);
    const response = await fetch(`/places-by-district/${district}/`);
    const data = await response.json();
    console.log("Fetched data:", data);

    if (!data.places || !data.places.length) {
      alert("No places found for this district.");
      return;
    }

    // Display the chart and map wrapper
    document.getElementById("chart-wrapper").style.display = "block";
    
    // Render the bar chart with the fetched data
    renderBarChart(data.places);

    // ðŸ”½ Scroll the chart into view
    const chartWrapper = document.getElementById("chart-wrapper");
    chartWrapper.scrollIntoView({ behavior: "smooth" });

    // ðŸ”½ Highlight the chart briefly
    chartWrapper.classList.add("chart-highlight");
    setTimeout(() => chartWrapper.classList.remove("chart-highlight"), 1500);

    // Display places on the map
    displayPlacesOnMap(data.places);

  } catch (error) {
    console.error("Error fetching places by district:", error);
  }
}

{% comment %} async function fetchPlacesByCategory(category){
  try{
    console response = await fetch('/places-by-category/${category}/');
    const data = await response.json();
    console.log("Fetched data:", data);

    if (!data.places || !data.places.length) {
      alert("No places found for this category.");
      return;
    }

    // Display the chart and map wrapper
    document.getElementById("chart-wrapper").style.display = "block";
    
    // Render the bar chart with the fetched data
    renderBarChart(data.places);
    
    // Display places on the map
    displayPlacesOnMap(data.places);

  } catch (error) {
    console.error("Error fetching places by district:", error);
  }
} 
 {% endcomment %}


{% comment %} 
async function fetchPlacesByDistrict(district) {
  try {
    console.log("Fetching places for category:", district);
    const response = await fetch(`/places-by-district/${district}/`);
    const data = await response.json();
    console.log("Fetched data for districtss:", data);

    if (!data.places || !data.places.length) {
      alert("No places found in this districtss.");
      return;
    }

    // Display the chart and map wrapper
    document.getElementById("chart-wrapper").style.display = "block";
    
    // Render the bar chart with the fetched data
    renderBarChart(data.places);
    
    // Display places on the map
    displayPlacesOnMap(data.places);

  } catch (error) {
    console.error("Error fetching places by category:", error);
  }
} {% endcomment %}

// Function to fetch places by category (hashtag)
async function fetchPlacesByCategory(category) {
  try {
    console.log("Fetching places for category:", category);
    const response = await fetch(`/places-by-category/${category}`);
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }

    const data = await response.json();

    console.log("Fetched data for category:", data);

    if (!data.places || !data.places.length) {
      alert("No places found in this category.");
      return;
    }

    // Display the chart and map wrapper
    document.getElementById("chart-wrapper").style.display = "block";

    // Render the bar chart with the fetched data
    renderBarChart(data.places);

    // ðŸ”½ Scroll the chart into view
    const chartWrapper = document.getElementById("chart-wrapper");
    chartWrapper.scrollIntoView({ behavior: "smooth" });

    // ðŸ”½ Highlight the chart briefly
    chartWrapper.classList.add("chart-highlight");
    setTimeout(() => chartWrapper.classList.remove("chart-highlight"), 1500);

    // Display places on the map
    displayPlacesOnMap(data.places);

  } catch (error) {
    console.error("Error fetching places by category:", error);
    alert("An error occurred while fetching places. Please try again.");
  }
}

// Function to display places on map
{% comment %} function displayPlacesOnMap(places) {
  clearMarkers(); // Clear existing Leaflet markers

  places.forEach(place => {
    if (place.lat && place.lng) {
      const marker = L.marker([place.lat, place.lng])
        .addTo(map)
        .bindPopup(`<b>${place.name}</b><br>${place.description || "No description"}`);
  
      marker.on('click', () => showPlaceInfo(place));
      mapMarkers.push(marker);
    }
  });
  

  // Center and zoom to the first valid place
  const firstPlace = places.find(p => p.latitude && p.longitude);
  if (firstPlace) {
    map.setView([firstPlace.latitude, firstPlace.longitude], 12);
  }
} {% endcomment %}
function showPlacesOnMap(places) {
  // Remove existing place markers or polylines if needed
  if (window.placeMarkers) {
    window.placeMarkers.forEach(marker => map.removeLayer(marker));
  }
  if (window.placePaths) {
    window.placePaths.forEach(path => map.removeLayer(path));
  }

  window.placeMarkers = [];
  window.placePaths = [];

  places.forEach(place => {
    const coords = [place.latitude, place.longitude]; // Ensure your API returns these

    // Create marker for each place
    const marker = L.marker(coords).addTo(map).bindPopup(place.name);
    window.placeMarkers.push(marker);

    // Draw line from user location to this place
    if (userLatLng) {
      const path = L.polyline([userLatLng, coords], {
        color: 'blue',
        weight: 2,
        dashArray: '4'
      }).addTo(map);
      window.placePaths.push(path);
    }
  });

  // Zoom out to fit all markers and user location
  const bounds = L.latLngBounds([
    ...places.map(p => [p.latitude, p.longitude]),
    userLatLng
  ]);
  map.fitBounds(bounds, { padding: [50, 50] });
}

let routingControl;
let routeClicks = [];
let routeClickCount = 1;

// Function to reverse geocode using OpenStreetMap Nominatim
async function reverseGeocode(lat, lng) {
  const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
  const data = await response.json();
  return data.display_name || "Unknown location";
}

// Main function
function displayPlacesOnMap(places) {
  places.forEach(place => {
    if (place.latitude && place.longitude) {
      const marker = L.marker([place.latitude, place.longitude]).addTo(map)
        .bindPopup(`<b>${place.name}</b><br>${place.description || "No description"}`);

      marker.on('click', () => {
        showPlaceInfo(place);

        // Remove previous routing and number markers
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
        // Remove any previous blue lines
        if (window.activeRouteLine) {
          map.removeLayer(window.activeRouteLine);
          window.activeRouteLine = null;
        }
        routeClicks.forEach(m => map.removeLayer(m));
        routeClicks = [];
        routeClickCount = 1;

        if (userLatLng) {
          const userLocation = L.latLng(userLatLng[0], userLatLng[1]);
          const placeLocation = L.latLng(place.latitude, place.longitude);

          routingControl = L.Routing.control({
            waypoints: [userLocation, placeLocation],
            draggableWaypoints: true,
            routeWhileDragging: false,
            createMarker: function(i, wp) {
              if (i === 0) {
                // Remove old marker
                if (userMarker) map.removeLayer(userMarker);

                // Create new draggable red marker
                userMarker = L.marker(wp.latLng, {
                  icon: redIcon,
                  draggable: true
                }).bindPopup("Your Location").addTo(map);

                // On dragend, update userLatLng and show location name
                userMarker.on('dragend', async function(e) {
                  const newPos = e.target.getLatLng();
                  userLatLng = [newPos.lat, newPos.lng];

                  const locationName = await reverseGeocode(newPos.lat, newPos.lng);
                  userMarker.bindPopup(`<b>Current Location:</b><br>${locationName}`).openPopup();

                  console.log("Updated user location:", locationName, userLatLng);
                });

                return userMarker;
              } else {
                // Blue marker at destination
                const blueIcon = new L.Icon({
                  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                  iconSize: [25, 41],
                  iconAnchor: [12, 41],
                  popupAnchor: [1, -34],
                  shadowSize: [41, 41]
                });
                return L.marker(wp.latLng, { icon: blueIcon }).bindPopup(place.name);
              }
            }
          }).addTo(map);

          // After route is created, draw line and allow number markers on click
          routingControl.on('routesfound', function(e) {
            // Remove previous blue line if exists
            if (window.activeRouteLine) {
              map.removeLayer(window.activeRouteLine);
            }
            window.activeRouteLine = L.polyline(e.routes[0].coordinates, { color: 'blue' }).addTo(map);
          });
        }
      });
    }
  });
}


          
  function displayPlaceDetails(place) {
    const detailsContainer = document.getElementById('place-details');
    detailsContainer.innerHTML = `
      <h2>${place.name}</h2>
      <p>${place.description}</p>
      <p><strong>Popular For:</strong> ${place.popular_for}</p>
      <p><strong>Location:</strong> ${place.lat}, ${place.lng}</p>
      <p><strong>Crowd Level:</strong> ${place.crowdlevel}</p>
      <!-- Add other details as needed -->
    `;
    detailsContainer.style.display = 'block'; // Show the details
  } 
  
  function showPlaceInfo(place) {
    const infoBox = document.getElementById("place-info-box");
    
    // Add close button if not exists
    if (!document.querySelector('.close-info')) {
      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-info';
      closeBtn.innerHTML = 'Ã—';
      closeBtn.onclick = () => {
        infoBox.classList.add('hidden');
        setTimeout(() => {
          infoBox.classList.remove('visible');
          infoBox.classList.remove('hidden');
        }, 300);
      };
      infoBox.appendChild(closeBtn);
    }

    // Update content
    document.getElementById("place-title").textContent = place.name;
    document.getElementById("place-description").textContent = place.description || "No description available.";
    document.getElementById("place-popular").textContent = place.popularfor || "N/A";
    document.getElementById("place-category").textContent = place.category || "N/A";
    document.getElementById("place-crowd").textContent = `${place.crowdlevel || "N/A"}%`;
    document.getElementById("place-status").textContent = place.status || "N/A";
    document.getElementById("place-tags").textContent = place.tags?.join(', ') || "N/A";

    // Fetch and display related places based on tags
    if (place.tags && place.tags.length > 0) {
      const relatedPlacesList = document.getElementById("related-places-list");
      relatedPlacesList.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';

      // If only one tag, fetch all places with that tag
      if (place.tags.length === 1) {
        fetchPlacesByTag(place.tags[0], 10);
      } else {
        // For multiple tags, fetch 2-3 places per tag
        const promises = place.tags.map(tag => fetchPlacesByTag(tag, 3));
        Promise.all(promises).then(() => {
          // All places have been fetched and displayed
        }).catch(error => {
          console.error('Error fetching related places:', error);
          relatedPlacesList.innerHTML = '<div class="alert alert-danger">Failed to load related places</div>';
        });
      }
    }

    // Show the info box with animation
    infoBox.classList.add('visible');
  }  

  function addToSearchHistory(district) {
    const historySection = document.getElementById("search-history-section");
    const list = document.getElementById("search-history-list");
    const item = document.createElement("li");
    item.textContent = district;
    list.appendChild(item);
    historySection.style.display = "block";
  }

  // Calculate distance between two points
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  async function fetchPlacesByTag(tag, limit) {
    try {
        const response = await fetch(`/places-by-tag/${tag}/`);
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        const relatedPlacesList = document.getElementById("related-places-list");

        if (!data.places || data.places.length === 0) {
            if (relatedPlacesList.innerHTML.includes('spinner-border')) {
                relatedPlacesList.innerHTML = '<div class="alert alert-info">No related places found</div>';
            }
            return;
        }

        // Limit the number of places to display
        const placesToShow = data.places.slice(0, limit);

        // Create HTML for the places
        const placesHTML = placesToShow.map(place => `
            <div class="related-place-card">
                <h6>${place.name}</h6>
                <p class="small text-muted">${place.description.substring(0, 100)}...</p>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary">${place.category}</span>
                    <span class="badge ${getCrowdLevelBadgeClass(place.crowdlevel)}">
                        ${place.crowdlevel}% Crowd
                    </span>
                </div>
            </div>
        `).join('');

        // Update the related places list
        if (relatedPlacesList.innerHTML.includes('spinner-border')) {
            relatedPlacesList.innerHTML = placesHTML;
        } else {
            relatedPlacesList.innerHTML += placesHTML;
        }

    } catch (error) {
        console.error(`Error fetching places for tag ${tag}:`, error);
        const relatedPlacesList = document.getElementById("related-places-list");
        if (relatedPlacesList.innerHTML.includes('spinner-border')) {
            relatedPlacesList.innerHTML = '<div class="alert alert-danger">Failed to load related places</div>';
        }
    }
  }

  function getCrowdLevelBadgeClass(crowdLevel) {
    if (crowdLevel > 70) return 'bg-danger';
    if (crowdLevel >= 30) return 'bg-warning';
    return 'bg-success';
  }

  // Add this function to fetch place by name and redirect
  async function fetchPlaceByName(placeName) {
    try {
      // Call the backend search API for place name
      const response = await fetch(`/api/search/?q=${encodeURIComponent(placeName)}`);
      const data = await response.json();
      if (data.places && data.places.length > 0) {
        // Redirect to placedetails of the first matching place
        const place = data.places[0];
        if (place.id) {
          window.location.href = `/place-details/${place.id}/`;
        } else {
          alert('No place ID found for that name.');
        }
      } else {
        alert('No place found with that name.');
      }
    } catch (error) {
      alert('Error searching for place.');
      console.error(error);
    }
  }
</script>
{% endblock %}